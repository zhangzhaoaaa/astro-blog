---
import { getCollection } from "astro:content";
import TagPosts from "@layouts/TagPosts.astro";
import getUniqueTags from "@utils/getUniqueTags";
import getPostsByTag from "@utils/getPostsByTag";
import getPagination from "@utils/getPagination";
import { slugifyStr } from "@utils/slugify";

export const prerender = false;

const { page, tag } = Astro.params as { page: string; tag: string };

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const tagSlug = slugifyStr(tag);
const matched = getUniqueTags(allPosts).find(t => t.tag === tagSlug);
const tagName: string = matched?.tagName ?? tag ?? tagSlug;

const postsByTag = getPostsByTag(allPosts, tag);

const pagination = getPagination({ posts: postsByTag, page });
---

<TagPosts {...pagination} {tag} {tagName} />
