---
import { getCollection } from "astro:content";
import TagPosts from "@layouts/TagPosts.astro";
import getPostsByTag from "@utils/getPostsByTag";
import getPagination from "@utils/getPagination";
import getUniqueTags from "@utils/getUniqueTags";
import { slugifyStr } from "@utils/slugify";

// Runtime data fetching for server output
const { tag: paramTag } = Astro.params as { tag: string };
const tag = paramTag;
const allPosts = await getCollection("blog", ({ data }) => !data.draft);

// Derive human-readable tag name if possible
const slug = slugifyStr(tag as string);
const matched = getUniqueTags(allPosts).find(t => t.tag === slug);
const tagName: string = matched?.tagName ?? (tag as string) ?? slug;

const postsByTag = getPostsByTag(allPosts, tag as string);

const pagination = getPagination({ posts: postsByTag, page: 1, isIndex: true });
---

<TagPosts {...pagination} {tag} {tagName} />
